<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 å®¸å®¸æ˜Ÿæ˜Ÿæ›¼è°·å¤§å†’éšª</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#81D4FA">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png"> 
    
    <link href="https://fonts.googleapis.com/css2?family=Itim&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* --- 1. åŸºç¤è¨­å®š --- */
        :root {
            --primary-color: #4AA3DF;
            --primary-dark: #3588c0;
            --accent-color: #FFD700;
            --bg-color: #E0F7FA;
            --text-color: #444;
            --card-bg: rgba(255, 255, 255, 0.95);
            --nav-height: 85px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* --- ğŸŒŸ V29 éå ´å‹•ç•« (Splash Screen) --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            /* èƒŒæ™¯è¨­å®šï¼špattern1.png ç„¡ç¸«æ‹¼è²¼ï¼Œå°ºå¯¸ 300px */
            background-color: #E1F5FE; 
            background-image: url('pattern1.png');
            background-size: 300px; 
            background-repeat: repeat;
            z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 1s ease-out, transform 1s ease-out;
            overflow: hidden;
        }
        
        .splash-content { 
            text-align: center; 
            position: relative; 
            z-index: 50; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* ä¸»åœ–ç¤º */
        .splash-icon {
            width: 250px; height: 250px; 
            border-radius: 50px; 
            object-fit: cover;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            animation: jelly-slow 3s infinite; 
            margin-bottom: 30px;
            background: transparent; 
        }

        /* æ¨™é¡Œå®¹å™¨ï¼šBaby Blue åœ“è§’æ–¹å¡Š */
        .splash-title-box {
            background-color: #B3E5FC;
            padding: 15px 30px;
            border-radius: 25px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            animation: float 4s ease-in-out infinite;
            border: 3px solid #fff;
        }

        /* æ¨™é¡Œæ–‡å­— */
        .splash-title {
            font-size: 1.5rem; 
            color: #0277BD; font-weight: bold;
            margin: 0;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.8);
            line-height: 1.4;
        }

        /* å½©è‰²è¼‰å…¥é»é» */
        .loading-dots { display: flex; gap: 12px; justify-content: center; margin-top: 15px; }
        .loading-dots span {
            width: 14px; height: 14px; border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            animation: bounce 1.4s infinite ease-in-out both;
            border: 2px solid #fff;
        }
        .loading-dots span:nth-child(1) { animation-delay: -0.32s; background-color: #FF9800; /* æ©˜è‰² */ }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; background-color: #FFEB3B; /* é»ƒè‰² */ }
        .loading-dots span:nth-child(3) { background-color: #4CAF50; /* ç¶ è‰² */ }
        
        /* âœˆï¸ é£›æ©Ÿç‰¹æ•ˆ (V29 RWD å„ªåŒ–ç‰ˆ) */
        .splash-plane { 
            position: absolute;
            width: 200px; /* å°ºå¯¸ç¶­æŒ 200px */
            z-index: 25; 
            filter: drop-shadow(10px 10px 5px rgba(0,0,0,0.1));
            /* æ™‚é–“æ”¹ç‚º 5ç§’ */
            animation: planeFlyUniversalFast 5s linear forwards; 
        }

        /* --- å‹•ç•« Keyframes --- */
        /* V29: ä½¿ç”¨ vw/vh å®šä½ï¼Œç¢ºä¿è·¨è£ç½®å¯è¦‹ä¸”è²«ç©¿å…¨è¢å¹• */
        @keyframes planeFlyUniversalFast { 
            0% { 
                left: -30vw; /* å¾ç•«é¢å·¦å¤–å´é–‹å§‹ */
                bottom: -30vh; /* å¾ç•«é¢ä¸‹å¤–å´é–‹å§‹ */
                transform: rotate(-35deg) scale(0.8); 
                opacity: 0;
            } 
            10% { 
                opacity: 1; /* å¿«é€Ÿæ·¡å…¥ */
            }
            90% {
                opacity: 1;
            }
            100% { 
                left: 130vw; /* é£›åˆ°ç•«é¢å³å¤–å´ */
                bottom: 130vh; /* é£›åˆ°ç•«é¢ä¸Šå¤–å´ */
                transform: rotate(-35deg) scale(1.2); 
                opacity: 0; /* æ·¡å‡ºæ¶ˆå¤± */
            } 
        }

        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes jelly-slow { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        @keyframes jelly { 0% { transform: scale(1); } 30% { transform: scale(1.25, 0.75); } 40% { transform: scale(0.75, 1.25); } 50% { transform: scale(1.15, 0.85); } 65% { transform: scale(0.95, 1.05); } 75% { transform: scale(1.05, 0.95); } 100% { transform: scale(1); } }
        @keyframes slideUpFade { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes breathe { 0% { box-shadow: 0 4px 10px rgba(74, 163, 223, 0.3); } 50% { box-shadow: 0 4px 20px rgba(74, 163, 223, 0.6); } 100% { box-shadow: 0 4px 10px rgba(74, 163, 223, 0.3); } }

        /* --- ä¸»ç¨‹å¼æ¨£å¼ --- */
        body {
            font-family: 'Itim', 'Noto Sans TC', cursive, sans-serif;
            margin: 0; padding: 0;
            background-image: url('èƒŒæ™¯åœ–.png'); 
            background-size: 300px; background-repeat: repeat; background-attachment: fixed;
            background-color: var(--bg-color); color: var(--text-color);
            padding-bottom: calc(var(--nav-height) + 20px); font-size: 16px;
            overscroll-behavior-y: contain; 
        }

        /* Header */
        header {
            background: rgba(255, 255, 255, 0.92); padding: 12px 10px; text-align: center;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
            box-shadow: 0 4px 15px rgba(74, 163, 223, 0.15); 
            position: sticky; top: 0; z-index: 100;
            padding-top: env(safe-area-inset-top); 
            backdrop-filter: blur(8px);
        }
        h1 { 
            margin: 0; font-size: 1.2rem; color: var(--primary-color); 
            display: flex; align-items: center; justify-content: center; gap: 8px; 
            padding-top: 5px; text-shadow: 1px 1px 0px #fff;
            animation: float 3.5s ease-in-out infinite; /* æ•´é«”æ¼‚æµ® */
        }
        /* åœ–ç¤ºè¨­å®š */
        .header-icon { height: 35px; width: auto; mix-blend-mode: multiply; }
        /* å³å´åœ–ç¤º (å¤§è±¡) */
        .header-icon-right { height: 35px; width: auto; object-fit: contain; } 
        
        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        
        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: var(--card-bg); border-radius: 25px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.05); border: 2px solid #fff; 
            transition: transform 0.2s;
            animation: slideUpFade 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
        }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        button {
            background-color: var(--primary-color); color: white; border: none; padding: 10px 20px;
            border-radius: 50px; font-family: inherit; cursor: pointer; font-size: 0.95rem; font-weight: bold;
            box-shadow: 0 4px 10px rgba(74, 163, 223, 0.3); transition: all 0.3s;
            position: relative; overflow: hidden;
        }
        button:active { animation: jelly 0.4s; transform: scale(0.95); }
        button.secondary { background-color: #FFB74D; box-shadow: 0 4px 10px rgba(255, 183, 77, 0.4); }
        button.danger { background-color: #FF7043; box-shadow: 0 4px 10px rgba(255, 112, 67, 0.4); }
        button.success { background-color: #66BB6A; box-shadow: 0 4px 10px rgba(102, 187, 106, 0.4); }
        button.outline { background: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); box-shadow: none; }
        button.icon-btn { padding: 6px 12px; border-radius: 15px; font-size: 1.1rem; }
        button.full-width { width: 100%; margin-top: 15px; animation: breathe 3s infinite ease-in-out; }

        input, textarea, select {
            width: 100%; padding: 12px; margin: 8px 0 15px 0; border: 2px solid #eee;
            border-radius: 15px; font-family: inherit; background: #fff; transition: 0.3s;
        }
        input:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(74, 163, 223, 0.1); }
        textarea { resize: vertical; min-height: 80px; }
        label { font-weight: bold; color: #555; font-size: 0.9rem; display: block; margin-top: 12px; }
        
        /* åº•éƒ¨å°èˆª */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(255, 255, 255, 0.98); display: flex; overflow-x: auto; align-items: center;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; padding: 0 5px;
            -ms-overflow-style: none; scrollbar-width: none;
            padding-bottom: env(safe-area-inset-bottom);
            border-top-left-radius: 25px; border-top-right-radius: 25px;
        }
        .bottom-nav::-webkit-scrollbar { display: none; }
        .nav-item {
            flex: 0 0 auto; width: 68px; text-align: center; padding: 5px; font-size: 0.7rem;
            color: #999; cursor: pointer; border-radius: 20px; margin: 0 3px; transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .nav-item.active { background-color: rgba(74, 163, 223, 0.15); color: var(--primary-color); font-weight: bold; transform: translateY(-5px); }
        .nav-item.active .nav-icon-img { animation: jelly 0.6s; } 
        .nav-icon-img { width: 34px; height: 34px; object-fit: contain; margin-bottom: 4px; display: block; mix-blend-mode: multiply; }
        
        /* é é¢åˆ‡æ› */
        .page { display: none; animation: slideUpFade 0.4s ease-out; }
        .page.active { display: block; }
        
        /* å…§å®¹æ¨£å¼ */
        .info-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #ddd; padding: 12px 0; align-items: baseline; }
        .info-label { color: #888; font-size: 0.9rem; min-width: 90px; font-weight: bold; }
        .info-value { font-weight: 500; text-align: right; flex-grow: 1; word-break: break-all; color: #444; }
        .section-title { 
            color: var(--primary-color); font-size: 1.15rem; font-weight: bold;
            border-bottom: 3px solid var(--accent-color); padding-bottom: 6px; margin: 20px 0 15px 0; display: inline-block; 
        }
        .edit-controls { text-align: right; margin-bottom: 10px; }
        .edit-group { 
            background: #f8fbfd; padding: 20px; border-radius: 20px; margin-bottom: 15px; 
            border: 2px solid #eef6fb; position: relative; animation: popIn 0.3s;
        }
        .delete-btn-corner { position: absolute; top: 10px; right: 10px; font-size: 0.8rem; background: #FF7043; color: white; padding: 4px 10px; border-radius: 15px;}
        
        /* è¡Œç¨‹åˆ†é  */
        .date-tabs-container { 
            display: flex; overflow-x: auto; padding: 10px 5px; margin-bottom: 10px; gap: 10px; 
            -ms-overflow-style: none; scrollbar-width: none; 
        }
        .date-tabs-container::-webkit-scrollbar { display: none; }
        .date-tab {
            flex: 0 0 auto; padding: 8px 14px; background: #fff; border: 2px solid #eee; 
            border-radius: 18px; font-size: 0.85rem; color: #888; cursor: pointer; transition: 0.3s;
            min-width: 85px; text-align: center; display: flex; flex-direction: column; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .date-tab.active { 
            background: var(--primary-color); color: white; border-color: var(--primary-color); 
            box-shadow: 0 4px 12px rgba(74, 163, 223, 0.4); transform: translateY(-2px) scale(1.05);
        }
        .day-label { font-size: 1rem; font-weight: bold; display: block; margin-bottom: 2px; }
        .day-date { font-size: 0.75rem; opacity: 0.9; font-family: sans-serif; }

        .timeline-item { border-left: 4px solid var(--primary-color); padding-left: 20px; margin-left: 10px; margin-bottom: 25px; position: relative; animation: slideUpFade 0.5s; }
        .timeline-item::before { 
            content: 'â˜…'; position: absolute; left: -10px; top: 0; color: var(--accent-color); background: #fff; 
            border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 22px; border: 2px solid var(--bg-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .timeline-header-box { 
            background: #E1F5FE; padding: 12px 15px; border-radius: 15px; margin-bottom: 10px; 
            display: inline-block; width: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid var(--primary-dark);
        }
        
        .detail-card { background: #fff; border: 1px solid #f0f0f0; border-radius: 15px; padding: 15px; margin-top: 8px; font-size: 0.95rem; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .detail-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: flex-start; }
        .detail-icon { color: var(--primary-color); font-weight: bold; min-width: 24px; text-align: center;}

        /* åœ°åœ– & MRT */
        #interactive-map { height: 60vh; width: 100%; border-radius: 20px; border: 4px solid #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        #mrt-container { overflow: auto; border: 4px solid var(--primary-color); border-radius: 20px; height: 60vh; background: white; position: relative; -webkit-overflow-scrolling: touch; }
        .zoom-controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; margin-top: 5px;}
        .zoom-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--primary-color); color: white; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); border: 2px solid #fff; padding: 0; transition: 0.2s; }
        .zoom-btn:active { transform: scale(0.9); }
        .zoom-btn.reset { background: #607D8B; font-size: 0.85rem; font-weight: bold; }
        
        /* è³¼ç‰© & ç¥¨åˆ¸ */
        .shopping-item { display: flex; align-items: flex-start; padding: 15px 10px; border-bottom: 1px dashed #ddd; transition: background 0.2s; animation: popIn 0.3s; }
        .shopping-item:active { background-color: #f0f8ff; }
        .shopping-item.checked { opacity: 0.5; text-decoration: line-through; filter: grayscale(0.8); }
        .check-circle { width: 26px; height: 26px; border: 2px solid #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; cursor: pointer; background: white; flex-shrink: 0; margin-top: 3px; transition: all 0.3s; }
        .checked .check-circle { background: #4CAF50; border-color: #4CAF50; color: white; transform: scale(1.1) rotate(360deg); }
        .shopping-cat { display: inline-block; background: #E1F5FE; color: var(--primary-color); padding: 3px 8px; border-radius: 8px; font-size: 0.75rem; margin-bottom: 5px; font-weight: bold; }
        
        .ticket-card { border: 2px dashed var(--primary-color); background: #f4fbff; border-radius: 20px; padding: 20px; margin-bottom: 15px; position: relative; animation: slideUpFade 0.5s; }
        .ticket-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 10px; }
        .ticket-title { font-size: 1.15rem; font-weight: bold; color: var(--primary-color); }
        .ticket-info-row { display: flex; margin-bottom: 6px; align-items: baseline; }
        .ticket-info-label { width: 75px; color: #666; font-size: 0.9rem; font-weight: bold; }
        .ticket-info-value { flex: 1; }
        .ticket-price-tag { background: var(--accent-color); color: #5d4037; padding: 3px 10px; border-radius: 12px; font-weight: bold; font-size: 0.85rem; margin-right: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* æ€¥é›£æ•‘åŠ© */
        .emergency-section h4 { color: #D84315; border-bottom: 2px solid #FFAB91; display: inline-block; margin-top: 15px; margin-bottom: 5px;}
        .emergency-section p { margin: 5px 0; line-height: 1.5; }
        
        /* äº’å‹•å…ƒä»¶ */
        details { margin-bottom: 10px; background: white; border-radius: 12px; border: 1px solid #eee; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: 0.3s; }
        summary { padding: 12px 15px; cursor: pointer; font-weight: bold; background: #fcfcfc; list-style: none; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        summary:hover { background: #f0f8ff; }
        summary::-webkit-details-marker { display: none; }
        summary::after { content: 'â–¼'; font-size: 0.8rem; color: #888; transition: 0.3s; }
        details[open] summary::after { transform: rotate(180deg); color: var(--primary-color); }
        .details-content { padding: 15px; background: #fff; border-top: 1px solid #eee; }
        
        /* è½‰ç§»èˆ‡å·¥å…· */
        .transfer-box { background: #37474F; color: #eceff1; padding: 20px; border-radius: 20px; margin-top: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        .transfer-box textarea { background: #263238; color: #69F0AE; border: 1px solid #546E7A; font-family: monospace; font-size: 0.85rem; height: 60px; }
        .auto-link { color: var(--primary-color); text-decoration: none; border-bottom: 1px dotted; font-weight: bold; }
        .auto-img { max-width: 100%; border-radius: 10px; margin-top: 8px; border: 1px solid #eee; display: block; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .file-upload-btn { background: #fff; color: #555; font-size: 0.9rem; padding: 10px 15px; border: 2px dashed #ccc; border-radius: 12px; width: 100%; margin-top: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .file-upload-btn:hover { border-color: var(--primary-color); color: var(--primary-color); background: #f0f8ff; }
        
        /* åå¸è¨Šæ¯ */
        #toast-container { position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%); z-index: 2000; pointer-events: none; width: max-content; }
        .toast { 
            background: rgba(0, 0, 0, 0.85); color: white; padding: 12px 30px; border-radius: 50px; 
            margin-top: 10px; font-size: 1rem; animation: slideUpFade 0.4s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 8px; backdrop-filter: blur(5px);
        }
    </style>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

<!-- ğŸŒŸ V29 è±ªè¯ Baby Blue éå ´å‹•ç•« -->
<div id="splash-screen">
    <div class="splash-content">
        <!-- æ”¾å¤§ä¸”ç„¡å¤–æ¡†çš„åœ–ç¤º -->
        <img src="icon.png" alt="App Icon" class="splash-icon" onerror="this.src='TH flag.png'">
        <div class="splash-title-box">
            <div class="splash-title">2026 å®¸å®¸æ˜Ÿæ˜Ÿ<br>æ›¼è°·å¤§å†’éšª</div>
        </div>
        <!-- å½©è‰²åœ“é» (æ©˜é»ƒç¶ ) -->
        <div class="loading-dots">
            <span></span><span></span><span></span>
        </div>
    </div>
    <!-- èƒŒæ™¯ç‰¹æ•ˆï¼šé£›æ©Ÿ (airplane1.png) -->
    <img src="airplane1.png" alt="Airplane" class="splash-plane">
</div>

<header>
    <h1>
        <!-- å·¦é‚Šåœ‹æ—— -->
        <img src="TH flag.png" class="header-icon" alt="Thai Flag">
        2026 å®¸å®¸æ˜Ÿæ˜Ÿæ›¼è°·å¤§å†’éšª
        <!-- å³é‚Šå¤§è±¡ (ä½¿ç”¨ elephant.png) -->
        <img src="elephant.png" class="header-icon-right" alt="Elephant">
    </h1>
</header>

<div id="toast-container"></div>

<div class="container">
    <!-- èˆªç­ -->
    <div id="page-flights" class="page active">
        <div class="card">
            <div class="edit-controls"><button onclick="toggleEdit('flights')" id="btn-edit-flights">âœï¸ ç·¨è¼¯</button></div>
            <div id="view-flights"></div>
            <div id="edit-flights" style="display:none;">
                <h3 class="section-title">âœˆï¸ å»ç¨‹ (Outbound)</h3><div id="edit-flights-outbound"></div>
                <h3 class="section-title">âœˆï¸ å›ç¨‹ (Inbound)</h3><div id="edit-flights-inbound"></div>
                <button onclick="saveData('flights')" class="full-width">ğŸ’¾ å„²å­˜èˆªç­è³‡æ–™</button>
            </div>
        </div>
    </div>
    
    <!-- é£¯åº— -->
    <div id="page-hotel" class="page">
        <div class="card">
            <div class="edit-controls"><button onclick="toggleEdit('hotel')" id="btn-edit-hotel">âœï¸ ç·¨è¼¯</button></div>
            <div id="view-hotel"></div>
            <div id="edit-hotel" style="display:none;">
                <div id="hotel-form-container"></div>
                <button class="secondary full-width" onclick="addHotel()">+ æ–°å¢é£¯åº—</button>
                <button onclick="saveData('hotel')" class="full-width">ğŸ’¾ å„²å­˜æ‰€æœ‰é£¯åº—</button>
            </div>
        </div>
    </div>
    
    <!-- è¡Œç¨‹ -->
    <div id="page-itinerary" class="page">
        <div class="edit-controls"><button onclick="toggleEdit('itinerary')" id="btn-edit-itinerary">âœï¸ ç·¨è¼¯æ¨¡å¼</button></div>
        <div id="itinerary-tabs" class="date-tabs-container"></div> <!-- åˆ†é  -->
        <div id="view-itinerary"></div>
        <div id="edit-itinerary" style="display:none;">
            <div id="itinerary-form-container"></div>
            <button class="secondary full-width" onclick="addDay()">+ æ–°å¢ä¸€å¤©</button>
            <button onclick="saveData('itinerary')" class="full-width">ğŸ’¾ å…¨éƒ¨å„²å­˜</button>
        </div>
    </div>

    <!-- åœ°åœ– -->
    <div id="page-interactive-map" class="page">
        <div class="card">
            <h3>ğŸ—ºï¸ æ™¯é»äº’å‹•åœ°åœ–</h3>
            <div id="interactive-map"></div>
            <p style="font-size:0.8rem; color:#999; margin-top:10px; text-align:center;">* åœ¨è¡Œç¨‹ä¸­è¼¸å…¥åº§æ¨™ï¼Œå°±æœƒè‡ªå‹•æ¨™ç¤ºåœ¨é€™è£¡å–”ï¼</p>
        </div>
    </div>
    
    <!-- æ·é‹ -->
    <div id="page-mrt" class="page">
        <div class="card">
            <h3>ğŸš‡ æ›¼è°·æ·é‹åœ–</h3>
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomMap(-25)">ï¼</button>
                <button class="zoom-btn reset" onclick="zoomMap(0)">é‡ç½®</button>
                <button class="zoom-btn" onclick="zoomMap(25)">ï¼‹</button>
            </div>
            <div id="mrt-container">
                <img id="mrt-img" src="bangkok_mrt_2025.png" alt="Bangkok MRT" style="width: 100%; min-width: 100%; transition: width 0.3s ease;" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Bangkok_Mass_Transit_Network_Map.png/1024px-Bangkok_Mass_Transit_Network_Map.png';this.alt='æœ¬åœ°åœ–ç‰‡æœªæ‰¾åˆ°'">
            </div>
        </div>
    </div>
    
    <!-- ç¥¨åˆ¸ -->
    <div id="page-tickets" class="page">
        <div class="card">
            <div class="edit-controls"><button onclick="toggleEdit('tickets')" id="btn-edit-tickets">âœï¸ ç·¨è¼¯</button></div>
            <div id="view-tickets"></div>
            <div id="edit-tickets" style="display:none;">
                <div id="tickets-form"></div>
                <button class="secondary full-width" onclick="addTicket()">+ æ–°å¢ç¥¨åˆ¸</button>
                <button onclick="saveData('tickets')" class="full-width">ğŸ’¾ å„²å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç¿»è­¯ -->
    <div id="page-translate" class="page">
        <div class="card">
            <h3>ğŸ‡¹ğŸ‡­ ç¿»è­¯å°å¹«æ‰‹</h3>
            <div class="trans-box"><label>ä¸­æ–‡ (ZH)</label><textarea id="trans-input" placeholder="è¼¸å…¥ä¸­æ–‡..."></textarea><button class="outline" onclick="speak('zh-TW', 'trans-input')">ğŸ”Š æ’­æ”¾ä¸­æ–‡</button></div>
            <div style="text-align:center; margin: 15px 0;"><button class="icon-btn" style="width:auto; border-radius:25px;" onclick="mockTranslate()">â¬‡ï¸ è·³è½‰ Google ç¿»è­¯ â¬‡ï¸</button></div>
            <div class="trans-box" style="background:#E1F5FE;"><label>æ³°æ–‡ (TH)</label><textarea id="trans-output" placeholder="é»æ“ŠæŒ‰éˆ•ç¿»è­¯..."></textarea><button class="outline" onclick="speak('th-TH', 'trans-output')">ğŸ”Š æ’­æ”¾æ³°æ–‡</button></div>
        </div>
    </div>
    
    <!-- æ³°æ–‡ -->
    <div id="page-phrases" class="page">
        <div class="card">
            <div class="edit-controls"><button onclick="toggleEdit('phrases')" id="btn-edit-phrases">âœï¸ ç®¡ç†</button></div>
            <div id="view-phrases"></div>
            <div id="edit-phrases" style="display:none;">
                <div id="phrases-form"></div>
                <button class="secondary full-width" onclick="addPhrase()">+ æ–°å¢å¥å‹</button>
                <button onclick="saveData('phrases')" class="full-width">ğŸ’¾ å„²å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- å¿…è²· -->
    <div id="page-shopping" class="page">
        <div class="card">
            <div class="edit-controls"><button onclick="toggleEdit('shopping')" id="btn-edit-shopping">âœï¸ ç·¨è¼¯æ¸…å–®</button></div>
            <div id="view-shopping"></div>
            <div id="edit-shopping" style="display:none;">
                <div id="shopping-form"></div>
                <button class="secondary full-width" onclick="addShoppingItem()">+ æ–°å¢å¿…è²·</button>
                <button onclick="saveData('shopping')" class="full-width">ğŸ’¾ å„²å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- ç­†è¨˜ -->
    <div id="page-notes" class="page">
        <div class="card">
            <div class="edit-controls"><button onclick="toggleEdit('notes')" id="btn-edit-notes">âœï¸ å¯«ç­†è¨˜</button></div>
            <div id="view-notes"></div>
            <div id="edit-notes" style="display:none;">
                <div id="notes-form"></div>
                <button class="secondary full-width" onclick="addNote()">+ æ–°å¢ç­†è¨˜</button>
                <button onclick="saveData('notes')" class="full-width">ğŸ’¾ å„²å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- æ€¥é›£æ•‘åŠ© -->
    <div id="page-emergency" class="page">
        <div class="card emergency-section" style="border-left: 5px solid #FF7043;">
            <h3 style="color:#D84315; text-align:center;">ğŸ†˜ æ€¥é›£æ•‘åŠ©</h3>
            <h4>ã€Šå°ç£å¤–äº¤éƒ¨ã€‹</h4><p>æ€¥é›£æ•‘åŠ©å°ˆç·šï¼ˆæµ·å¤–ç›´æ’¥ï¼‰ï¼š<a href="tel:080008509">0800-085-09</a></p>
            <h4>ã€Šé§æ³°åœ‹å°åŒ—ç¶“æ¿Ÿæ–‡åŒ–è¾¦äº‹è™•ã€‹</h4>
            <p>ç·Šæ€¥é›»è©±ï¼ˆéä¸Šç­æ™‚é–“ï¼‰ï¼š<a href="tel:+66816664006" style="color:red; font-weight:bold;">+66-81-6664006</a></p>
            <p>è¾¦å…¬å®¤é›»è©±ï¼ˆä¸Šç­æ™‚é–“ï¼‰ï¼š<a href="tel:+6621193555">+66-2-119-3555</a></p>
            <p>é›»å­éƒµä»¶ï¼š<a href="mailto:tha@mofa.gov.tw">tha@mofa.gov.tw</a></p>
            <h4>ã€Šæ³°åœ‹ç•¶åœ°ç·Šæ€¥é›»è©±ã€‹</h4>
            <p><strong>è§€å…‰è­¦å¯Ÿï¼š1155</strong> (ä¸­æ–‡æœå‹™)</p><p>é†«ç™‚æ€¥æ•‘ä¸­å¿ƒï¼š1669 æˆ– 1554</p><p>æ¶ˆè²»è€…ä¿è­·è¾¦å…¬å®¤ï¼š1166</p>
            <p style="background:#FFF3E0; padding:10px; font-size:0.85rem; border-radius:10px; margin-top:10px;">æ€¥é›£æ•‘åŠ©å°ˆç·šåƒ…é™ç·Šæ€¥æƒ…æ³ï¼ˆè»Šç¦ã€æ¶åŠ«ã€ç”Ÿå‘½å®‰å±ï¼‰ã€‚<br>ä¸€èˆ¬å•é¡Œè«‹æ–¼ä¸Šç­æ™‚é–“è¯ç¹«è¾¦äº‹è™•ã€‚</p>
            <h4>ã€ŠLINEå¸³è™Ÿã€‹</h4><p>ä¿å¹³å®‰æœå‹™å°ˆç·š LINE ID: <strong>@Taiwan119</strong></p>
        </div>

        <!-- ğŸ”„ è³‡æ–™è½‰ç§»å€å¡Š (æª”æ¡ˆæ¨¡å¼) -->
        <div class="card transfer-box">
            <h3 style="color:#fff;">ğŸ”„ å‚™ä»½èˆ‡é‚„åŸ (JSON æª”æ¡ˆ)</h3>
            <div style="font-size:0.9rem; color:#ddd; margin-bottom:10px; line-height:1.6;">
                <b>æ“ä½œæ–¹å¼ï¼š</b><br>
                1. é»æ“Š <span style="color:#FFD700;">ğŸ“¤ åŒ¯å‡ºå‚™ä»½</span> (ä¸‹è¼‰ .json æª”)<br>
                2. å°‡æª”æ¡ˆå‚³é€åˆ°å¦ä¸€å°è£ç½®<br>
                3. åœ¨å¦ä¸€å°è£ç½®é»æ“Š <span style="color:#4CAF50;">ğŸ“¥ åŒ¯å…¥å‚™ä»½</span><br>
                4. é¸å–è©² .json æª”æ¡ˆå³å¯é‚„åŸ
            </div>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="secondary" onclick="exportJSON()" style="flex:1;">ğŸ“¤ åŒ¯å‡ºå‚™ä»½æª”</button>
                <button class="success" onclick="triggerImport()" style="flex:1;">ğŸ“¥ åŒ¯å…¥å‚™ä»½æª”</button>
            </div>
            <input type="file" id="import-file" style="display: none;" accept=".json" onchange="handleFileImport(this)">
        </div>

        <div style="text-align:center; margin-top:20px;"><button onclick="resetApp()" class="danger" style="opacity:0.6;">âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button></div>
    </div>
</div>

<!-- åº•éƒ¨å°èˆª -->
<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchPage('flights', this)"><img src="airplane.png" class="nav-icon-img"><span>èˆªç­</span></div>
    <div class="nav-item" onclick="switchPage('hotel', this)"><img src="hotel.png" class="nav-icon-img"><span>é£¯åº—</span></div>
    <div class="nav-item" onclick="switchPage('itinerary', this)"><img src="liti.png" class="nav-icon-img"><span>è¡Œç¨‹</span></div>
    
    <!-- åœ°åœ–æŒ‰éˆ• (å€’æ•¸ç¬¬äºŒ) -->
    <div class="nav-item" onclick="switchPage('interactive-map', this)"><img src="map.png" class="nav-icon-img"><span>åœ°åœ–</span></div>

    <div class="nav-item" onclick="switchPage('mrt', this)"><img src="train.png" class="nav-icon-img"><span>æ·é‹</span></div>
    <div class="nav-item" onclick="switchPage('tickets', this)"><img src="ticket.png" class="nav-icon-img" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjODg4IiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTIgOWE1IDUgMCAwIDAgMTAgMHY2YTUgNSAwIDAgMCAxMCAwdi02YTUgNSAwIDAgMC0xMCAwVjJINnY3eiIvPjwvc3ZnPg=='"><span>ç¥¨åˆ¸</span></div>
    <div class="nav-item" onclick="switchPage('translate', this)"><img src="man.png" class="nav-icon-img"><span>ç¿»è­¯</span></div>
    <div class="nav-item" onclick="switchPage('phrases', this)"><img src="TH flag.png" class="nav-icon-img"><span>æ³°æ–‡</span></div>
    <div class="nav-item" onclick="switchPage('shopping', this)"><img src="shoppingbag.png" class="nav-icon-img"><span>å¿…è²·</span></div>
    <div class="nav-item" onclick="switchPage('notes', this)"><img src="note.png" class="nav-icon-img"><span>ç­†è¨˜</span></div>
    <div class="nav-item" onclick="switchPage('emergency', this)"><img src="SOS.png" class="nav-icon-img"><span>æ±‚åŠ©</span></div>
</nav>

<script>
    const STORAGE_KEY = 'TravelApp_2026_V29_RWDPlane'; // ğŸš€ V29 æ›´æ–° KEY

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Fail', err));
        });
    }

    // ğŸŒŸ Splash Screen é‚è¼¯ (å»¶é² 5ç§’)
    window.addEventListener('load', () => {
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            splash.style.opacity = '0';
            splash.style.transform = 'scale(1.1)';
            setTimeout(() => { splash.style.display = 'none'; }, 1000); 
        }, 5000); 
    });

    const defaultPhrases = [
        {zh:"ä½ å¥½", th:"Sawasdee (krub/ka)"}, {zh:"è¬è¬", th:"Khop khun (krub/ka)"}, {zh:"å°ä¸èµ·", th:"Kor tot"}, {zh:"æ²’é—œä¿‚", th:"Mai pen rai"},
        {zh:"æ˜¯çš„", th:"Chai"}, {zh:"ä¸æ˜¯", th:"Mai chai"}, {zh:"å¤šå°‘éŒ¢?", th:"Tao rai?"}, {zh:"å¤ªè²´äº†", th:"Paeng pai"},
        {zh:"ä¾¿å®œä¸€é»", th:"Lot noi dai mai?"}, {zh:"æˆ‘æƒ³è¦é€™å€‹", th:"Ao an nee"}, {zh:"ä¸è¦", th:"Mai ao"}, {zh:"æœ‰...å—?", th:"Mee ... mai?"},
        {zh:"å»æ‰€åœ¨å“ª?", th:"Hong nam yoo tee nai?"}, {zh:"ç›´èµ°", th:"Dtrohng bpai"}, {zh:"å·¦è½‰", th:"Liao sai"}, {zh:"å³è½‰", th:"Liao kwa"},
        {zh:"æ•‘å‘½", th:"Chuay duay"}, {zh:"é†«é™¢", th:"Rong payaban"}, {zh:"è­¦å¯Ÿ", th:"Dtam ruat"}, {zh:"æˆ‘è¿·è·¯äº†", th:"Chan long tang"},
        {zh:"å¥½", th:"Dee"}, {zh:"å¥½åƒ", th:"Aroy"}, {zh:"ä¸è¾£", th:"Mai phet"}, {zh:"ä¸€é»é»è¾£", th:"Phet nit noi"},
        {zh:"ä¸è¦é¦™èœ", th:"Mai sai pak chee"}, {zh:"è²·å–®", th:"Check bin / Gep tang"}, {zh:"æ°´", th:"Nam"}, {zh:"å†°å¡Š", th:"Nam kaeng"},
        {zh:"ç†±", th:"Ron"}, {zh:"å†·", th:"Nao/Yen"}, {zh:"èˆ’æœ", th:"Sabai"}, {zh:"æ¼‚äº®", th:"Suay"}, {zh:"å¯æ„›", th:"Narak"},
        {zh:"å¹¾é»?", th:"Gee mong?"}, {zh:"ä»€éº¼?", th:"Arai na?"}, {zh:"ä¸æ‡‚/ä¸æ˜ç™½", th:"Mai kao jai"}, {zh:"å¯ä»¥æ‹ç…§å—?", th:"Tai roop dai mai?"},
        {zh:"æ©Ÿå ´", th:"Sanam bin"}, {zh:"é£¯åº—", th:"Rong raem"}, {zh:"è¨ˆç¨‹è»Š", th:"Taxi"}, {zh:"åœåœ¨é€™è£¡", th:"Jort tee nee"},
        {zh:"å»...", th:"Bpai ..."}, {zh:"é€™è£¡", th:"Tee nee"}, {zh:"é‚£è£¡", th:"Tee nan"}, {zh:"ç¾åœ¨", th:"Dton nee"},
        {zh:"ä»Šå¤©", th:"Wan nee"}, {zh:"æ˜å¤©", th:"Prung nee"}, {zh:"æ˜¨å¤©", th:"Meua wan"}, {zh:"ç”·äºº", th:"Poo chai"}, {zh:"å¥³äºº", th:"Poo ying"}
    ];

    const defaultData = {
        flights: { 
            outbound: { airline: 'æ˜Ÿå®‡èˆªç©º', origin: 'å°åŒ— (TPE)', terminal: 'ç¬¬ä¸€èˆªå»ˆ', number: 'JX741', date: '2026-02-10', time: '10:00', boardingTime: '09:30', gate: 'B5', pnr: 'AB1234', price: '12000', notes: '', passengers: [{name:'å®¸å®¸', seat:'12A'}, {name:'æ˜Ÿæ˜Ÿ', seat:'12B'}] }, 
            inbound: { airline: 'æ˜Ÿå®‡èˆªç©º', origin: 'æ›¼è°· (BKK)', terminal: '-', number: 'JX742', date: '2026-02-15', time: '14:00', boardingTime: '13:30', gate: 'D2', pnr: 'AB1234', price: '12000', notes: '', passengers: [{name:'å®¸å®¸', seat:'15C'}, {name:'æ˜Ÿæ˜Ÿ', seat:'15D'}] } 
        },
        hotels: [{ name: 'The Standard, Bangkok', address: '114 Narathiwas Road', transport:'BTS Chong Nonsi', checkin:'2026-02-10', checkout:'2026-02-13', voucher:'', photo:'', surroundings:'è¿‘æœ€é«˜æ¨“è§€æ™¯å°', notes: 'è¨˜å¾—è¦é«˜æ¨“å±¤' }],
        itinerary: [
            { date: '2026-02-10', summary: 'æŠµé”æ›¼è°·', items: [{ time:'14:00', title:'é£¯åº— Check-in', desc:'è¾¦ç†å…¥ä½æ‰‹çºŒ', transport:'æ©Ÿå ´å¿«ç·š', lat:'13.7228', lng:'100.5292', mapUrl:'', hours:'24H', mustBuy:'', menu:'', voucher:'', photo:'', notes:'' }] },
            { date: '2026-02-11', summary: 'æ²³å²¸ä¸€æ—¥éŠ', items: [{ time:'09:00', title:'é„­ç‹å»Ÿ', desc:'å¿…æ‹åœ°æ¨™', transport:'èˆ¹', lat:'13.7437', lng:'100.4888', mapUrl:'', hours:'', mustBuy:'', menu:'', voucher:'', photo:'', notes:'' }] }
        ],
        tickets: [], 
        phrases: defaultPhrases,
        shopping: [{ category:'é£²æ–™', item:'æ‰‹æ¨™å¥¶èŒ¶', price:'140', location:'Big C', image:'', notes:'åŠç³–å‰›å¥½', done: false }],
        notes: [{ date: 'æé†’', content: 'è¨ˆç¨‹è»Šè¦è¨˜å¾—å–Š By Meter (è·³è¡¨)ï¼' }]
    };

    let appData;
    try {
        const stored = localStorage.getItem(STORAGE_KEY);
        appData = stored ? JSON.parse(stored) : defaultData;
    } catch(e) {
        console.log('Data reset');
        appData = defaultData;
    }

    if(!appData.flights || !appData.flights.outbound) appData.flights = defaultData.flights;
    if(!Array.isArray(appData.hotels)) appData.hotels = defaultData.hotels;
    if(!Array.isArray(appData.itinerary)) appData.itinerary = defaultData.itinerary;
    if(!Array.isArray(appData.tickets)) appData.tickets = []; 
    if(!Array.isArray(appData.phrases)) appData.phrases = defaultPhrases;
    if(!Array.isArray(appData.shopping)) appData.shopping = defaultData.shopping;
    if(!Array.isArray(appData.notes)) appData.notes = defaultData.notes;

    localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));

    let currentItineraryDayIndex = 0;
    let map = null;
    let markers = [];

    // --- âœ¨ åå¸é€šçŸ¥ ---
    function showToast(message) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.innerHTML = `<span>âœ¨</span> ${message}`;
        container.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 2000);
    }

    function saveToLocal() { 
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); 
        } catch(e) {
            alert('âš ï¸ å„²å­˜å¤±æ•—ï¼åœ–ç‰‡æª”æ¡ˆå¯èƒ½éå¤§ã€‚');
        }
    }
    
    function saveData(section) { 
        saveToLocal(); 
        showToast('å„²å­˜æˆåŠŸï¼'); 
        if(section === 'itinerary') renderView('itinerary'); 
        toggleEdit(section); 
    }

    function saveImage(section) { saveToLocal(); showToast('åœ–ç‰‡ä¸Šå‚³æˆåŠŸï¼'); } 
    function resetApp() { if(confirm("âš ï¸ ç¢ºå®šé‡ç½®ï¼Ÿæ‰€æœ‰è³‡æ–™å°‡æ¶ˆå¤±ï¼")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }

    function switchPage(pageId, navEl) {
        document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
        document.getElementById('page-' + pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        navEl.classList.add('active');
        
        if(pageId === 'interactive-map') {
            setTimeout(initMap, 200); 
        }
        
        renderView(pageId);
    }

    function toggleEdit(section) {
        const v = document.getElementById(`view-${section}`);
        const e = document.getElementById(`edit-${section}`);
        const btn = document.getElementById(`btn-edit-${section}`);
        if (e.style.display === 'none') { e.style.display = 'block'; v.style.display = 'none'; btn.innerText = 'ğŸ‘€ è¿”å›æª¢è¦–'; } 
        else { e.style.display = 'none'; v.style.display = 'block'; btn.innerText = 'âœï¸ ç·¨è¼¯'; }
        renderView(section);
    }

    function initMap() {
        if(map) {
            map.invalidateSize();
            loadMapMarkers();
            return;
        }
        map = L.map('interactive-map').setView([13.7563, 100.5018], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        loadMapMarkers();
    }

    function loadMapMarkers() {
        markers.forEach(m => map.removeLayer(m));
        markers = [];
        appData.itinerary.forEach(day => {
            day.items.forEach(item => {
                if(item.lat && item.lng) {
                    const marker = L.marker([item.lat, item.lng])
                        .addTo(map)
                        .bindPopup(`<b>${item.time} ${item.title}</b><br>${item.desc}`);
                    markers.push(marker);
                }
            });
        });
    }

    function switchItineraryDay(index) {
        currentItineraryDayIndex = index;
        renderView('itinerary');
    }

    function formatContent(text) {
        if (!text) return '';
        const str = String(text); 
        if (str.startsWith('data:image')) return `<img src="${str}" class="auto-img" alt="åœ–ç‰‡"><br><small>æœ¬åœ°åœ–ç‰‡</small>`;
        if (str.match(/\.(jpeg|jpg|gif|png|webp)(\?.*)?$/i) && str.startsWith('http')) return `<a href="${str}" target="_blank"><img src="${str}" class="auto-img" alt="åœ–ç‰‡"></a><br><small><a href="${str}" target="_blank" class="auto-link">æŸ¥çœ‹åŸåœ–</a></small>`;
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        return str.replace(urlRegex, (url) => `<a href="${url}" target="_blank" class="auto-link">ğŸ”— é–‹å•Ÿé€£çµ</a>`);
    }

    function compressImage(file, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(event) {
            const img = new Image();
            img.src = event.target.result;
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const maxWidth = 600; 
                const scaleSize = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scaleSize;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6); 
                callback(dataUrl);
            }
        }
    }

    function exportJSON() {
        const dataStr = JSON.stringify(appData, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const date = new Date().toISOString().slice(0,10);
        a.download = `bangkok_backup_${date}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function triggerImport() { document.getElementById('import-file').click(); }

    function handleFileImport(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const newData = JSON.parse(e.target.result);
                if (newData.flights) {
                    appData = newData;
                    if(!appData.tickets) appData.tickets = [];
                    saveToLocal();
                    showToast("è³‡æ–™é‚„åŸæˆåŠŸï¼é é¢é‡æ•´ä¸­...");
                    setTimeout(() => location.reload(), 1500);
                } else { alert("âŒ æ ¼å¼éŒ¯èª¤"); }
            } catch (error) { alert("âŒ è®€å–å¤±æ•—"); }
        };
        reader.readAsText(file);
        input.value = ''; 
    }

    function renderView(section) { 
        try { if(renderers[section]) renderers[section](); } 
        catch(e) { console.error('Render error:', e); }
    }

    const renderers = {
        flights: () => {
            const flightFields = { airline: 'èˆªç©ºå…¬å¸', origin:'å‡ºç™¼åœ°é»', terminal:'èˆªå»ˆ', number: 'èˆªç­è™Ÿç¢¼', date: 'èˆªç­æ—¥æœŸ', time: 'å‡ºç™¼æ™‚é–“', boardingTime:'ç™»æ©Ÿæ™‚é–“', gate: 'ç™»æ©Ÿé–€', pnr: 'è¨‚ä½ä»£ç¢¼', price:'ç¥¨åƒ¹', notes:'å‚™è¨»' };
            const genView = (t, d) => {
                let h = `<h3 class="section-title">${t}</h3>`;
                for (let k in flightFields) h += `<div class="info-row"><span class="info-label">${flightFields[k]}</span><span class="info-value">${formatContent(d[k] || '-')}</span></div>`;
                h += `<div class="info-row"><span class="info-label">æ—…å®¢/åº§ä½</span><span class="info-value">` + (d.passengers || []).map(p => `${p.name} (${p.seat})`).join(', ') + `</span></div>`;
                return h;
            };
            document.getElementById('view-flights').innerHTML = genView('âœˆï¸ å»ç¨‹ (Outbound)', appData.flights.outbound) + '<br>' + genView('âœˆï¸ å›ç¨‹ (Inbound)', appData.flights.inbound);
            const genEdit = (type, data) => {
                let html = '';
                for (let k in flightFields) {
                    html += `<label>${flightFields[k]}</label>`;
                    if(k==='notes') html += `<textarea onchange="appData.flights.${type}.${k}=this.value">${data[k]||''}</textarea>`;
                    else html += `<input value="${data[k]||''}" onchange="appData.flights.${type}.${k}=this.value">`;
                }
                html += `<label>æ—…å®¢å§“å èˆ‡ åº§ä½è™Ÿç¢¼ (å¯æ–°å¢åˆªæ¸›)</label><div id="passengers-${type}">`;
                (data.passengers || []).forEach((p, idx) => {
                    html += `<div style="display:flex; gap:5px; margin-bottom:5px;"><input placeholder="å§“å" value="${p.name}" onchange="appData.flights.${type}.passengers[${idx}].name=this.value"><input placeholder="åº§ä½" value="${p.seat}" onchange="appData.flights.${type}.passengers[${idx}].seat=this.value"><button class="danger icon-btn" onclick="removePax('${type}', ${idx})">ğŸ—‘ï¸</button></div>`;
                });
                html += `</div><button class="secondary outline full-width" onclick="addPax('${type}')">â• æ–°å¢æ—…å®¢</button>`;
                return html;
            };
            document.getElementById('edit-flights-outbound').innerHTML = genEdit('outbound', appData.flights.outbound);
            document.getElementById('edit-flights-inbound').innerHTML = genEdit('inbound', appData.flights.inbound);
        },
        hotel: () => {
            document.getElementById('view-hotel').innerHTML = appData.hotels.map((h, i) => `
                <div style="border-bottom:3px solid var(--accent-color); padding-bottom:15px; margin-bottom:15px;">
                    <h3 style="color:var(--primary-color); margin-bottom:5px;">ğŸ¨ ${i+1}. ${h.name}</h3>
                    <div class="info-row"><span class="info-label">åœ°å€</span><span class="info-value">${h.address}</span></div>
                    <div class="info-row"><span class="info-label">äº¤é€š</span><span class="info-value">${h.transport}</span></div>
                    <div class="info-row"><span class="info-label">æ—¥æœŸ</span><span class="info-value">${h.checkin} ~ ${h.checkout}</span></div>
                    <div class="info-row"><span class="info-label">æ†‘è­‰</span><span class="info-value">${formatContent(h.voucher)}</span></div>
                    ${h.photo ? `<div class="info-row"><span class="info-label">ç…§ç‰‡</span><span class="info-value">${formatContent(h.photo)}</span></div>` : ''}
                    <div class="detail-card" style="background:#FFF9C4;"><div><b>é€±é‚Šç’°å¢ƒï¼š</b>${h.surroundings}</div><div style="margin-top:5px;"><b>å‚™è¨»ï¼š</b>${h.notes}</div></div>
                </div>`).join('');
            const fields = { name:'é£¯åº—åç¨±', address:'åœ°å€', transport:'äº¤é€šæ–¹å¼', checkin:'å…¥ä½ (YYYY-MM-DD)', checkout:'é€€æˆ¿', voucher:'å…¥ä½æ†‘è­‰', photo:'ç…§ç‰‡é€£çµ', surroundings:'é€±é‚Šç’°å¢ƒ', notes:'å‚™è¨»' };
            document.getElementById('hotel-form-container').innerHTML = appData.hotels.map((h, idx) => `
                <div class="edit-group"><button class="icon-btn delete-btn-corner danger" onclick="removeHotel(${idx})">ğŸ—‘ï¸</button><h4 style="margin-top:0;">é£¯åº— ${idx+1}</h4>${Object.entries(fields).map(([k, label]) => `<label>${label}</label>${(k.includes('notes')||k.includes('surr')) ? `<textarea onchange="appData.hotels[${idx}].${k}=this.value">${h[k]}</textarea>` : `<input value="${h[k]}" onchange="appData.hotels[${idx}].${k}=this.value">`}`).join('')}</div>`).join('');
        },
        itinerary: () => {
            const tabsHtml = appData.itinerary.map((d, i) => 
                `<div class="date-tab ${i === currentItineraryDayIndex ? 'active' : ''}" onclick="switchItineraryDay(${i})">
                    <span class="day-label">Day ${i+1}</span>
                    <span class="day-date">${d.date || 'æ—¥æœŸæœªå®š'}</span>
                </div>`
            ).join('');
            document.getElementById('itinerary-tabs').innerHTML = tabsHtml;

            const currentDay = appData.itinerary[currentItineraryDayIndex];
            if(currentDay) {
                const itemsHtml = currentDay.items.map(i => {
                    const mapLink = i.mapUrl ? `<a href="${i.mapUrl}" target="_blank">ğŸ“ é»é–‹åœ°åœ–</a>` : (i.title ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.title + ' Bangkok')}" target="_blank">ğŸ” æœåœ°åœ–</a>` : '');
                    return `<div class="timeline-item">
                        <div class="timeline-header-box"><div style="font-weight:bold; color:var(--primary-color); font-size:1.1rem;">${i.time} ${i.title}</div><div style="color:#555; font-size:0.9rem;">${i.desc || ''}</div></div>
                        <div class="detail-card">
                            ${i.transport?`<div class="detail-row"><span class="detail-icon">ğŸšŒ</span> ${i.transport}</div>`:''}
                            ${mapLink?`<div class="detail-row"><span class="detail-icon">ğŸ—ºï¸</span> ${mapLink}</div>`:''}
                            ${i.hours?`<div class="detail-row"><span class="detail-icon">ğŸ•’</span> ${i.hours}</div>`:''}
                            ${i.mustBuy?`<div class="detail-row"><span class="detail-icon">ğŸ›ï¸</span> å¿…è²·: ${i.mustBuy}</div>`:''}
                            ${i.menu?`<div class="detail-row"><span class="detail-icon">ğŸ´</span> æ¨è–¦: ${i.menu}</div>`:''}
                            ${i.voucher?`<div class="detail-row"><span class="detail-icon">ğŸ«</span> æ†‘è­‰: ${formatContent(i.voucher)}</div>`:''}
                            ${i.photo?`<div class="detail-row"><span class="detail-icon">ğŸ“·</span> ç…§ç‰‡: ${formatContent(i.photo)}</div>`:''}
                            ${i.notes?`<div class="detail-row"><span class="detail-icon">ğŸ“</span> å‚™è¨»: ${formatContent(i.notes)}</div>`:''}
                        </div>
                    </div>`;
                }).join('');
                
                document.getElementById('view-itinerary').innerHTML = `
                    <div class="day-summary" style="text-align:center;color:#666;margin-bottom:20px;background:#FFF9C4;display:inline-block;padding:5px 15px;border-radius:15px;width:100%;">${currentDay.summary}</div>
                    ${itemsHtml}
                `;
            }

            const itemFields = { time:'æ™‚é–“', title:'æ¨™é¡Œ', desc:'ç°¡è¿°', transport:'äº¤é€š', lat:'ç·¯åº¦ (åœ°åœ–ç”¨)', lng:'ç¶“åº¦ (åœ°åœ–ç”¨)', mapUrl:'Googleåœ°åœ–é€£çµ', hours:'ç‡Ÿæ¥­æ™‚é–“', mustBuy:'å¿…è²·', menu:'æ¨è–¦èœå–®', voucher:'æ†‘è­‰', photo:'ç…§ç‰‡', notes:'å‚™è¨»' };
            document.getElementById('itinerary-form-container').innerHTML = appData.itinerary.map((d, dIdx) => `
                <div class="edit-group" style="border:2px solid var(--accent-color);"><button class="icon-btn delete-btn-corner danger" onclick="removeDay(${dIdx})">ğŸ—‘ï¸</button>
                <label>Day ${dIdx+1} æ—¥æœŸ</label><input type="date" value="${d.date}" onchange="appData.itinerary[${dIdx}].date=this.value">
                <label>ç•¶æ—¥ä¸»é¡Œ</label><input value="${d.summary}" onchange="appData.itinerary[${dIdx}].summary=this.value">
                <hr style="margin:10px 0;"><label>è¡Œç¨‹é …ç›® (é»æ“Šå±•é–‹)</label>
                <div id="day-${dIdx}-items">${d.items.map((item, iIdx) => `<details><summary>${item.time || 'æ™‚é–“'} - ${item.title || 'é …ç›®'} <span onclick="removeItm(${dIdx}, ${iIdx})" style="float:right; color:red;">ğŸ—‘ï¸</span></summary><div class="details-content">${Object.entries(itemFields).map(([k, label]) => {
                    if(k==='photo'){return `<label>${label}</label><input placeholder="è²¼ä¸Šç¶²å€" value="${item[k]||''}" onchange="appData.itinerary[${dIdx}].items[${iIdx}].${k}=this.value" id="it-img-${dIdx}-${iIdx}"><label class="file-upload-btn">ğŸ“ ä¸Šå‚³åœ–ç‰‡<input type="file" style="display:none;" accept="image/*" onchange="compressImage(this.files[0], (base64) => { appData.itinerary[${dIdx}].items[${iIdx}].photo = base64; document.getElementById('it-img-${dIdx}-${iIdx}').value = 'å·²è¼‰å…¥åœ–ç‰‡'; saveImage('itinerary'); })"></label>`;}
                    return `<label>${label}</label><input value="${item[k]||''}" onchange="appData.itinerary[${dIdx}].items[${iIdx}].${k}=this.value">`;
                }).join('')}</div></details>`).join('')}</div>
                <button class="outline full-width" onclick="addItm(${dIdx})">â• æ–°å¢é …ç›®</button></div>`).join('');
        },
        tickets: () => {
            const ticketFields = { name:'ç¥¨åˆ¸åç¨±', date:'æ—¥æœŸ', time:'æ™‚é–“', priceAdult:'æˆäººåƒ¹æ ¼', priceChild:'å…’ç«¥åƒ¹æ ¼', location:'åœ°é»', image:'æ†‘è­‰åœ–ç‰‡', notes:'å‚™è¨»' };
            const list = appData.tickets || [];
            document.getElementById('view-tickets').innerHTML = list.length ? list.map(t => `
                <div class="ticket-card"><div class="ticket-header"><div class="ticket-title">${t.name || 'æœªå‘½å'}</div><div style="font-size:0.9rem; color:#666;">${t.date || ''} ${t.time || ''}</div></div><div class="ticket-info-row"><span class="ticket-info-label">åƒ¹æ ¼:</span><div class="ticket-info-value"><span class="ticket-price-tag">æˆäºº: ${t.priceAdult}</span> <span class="ticket-price-tag" style="background:#E0F2F1; color:#00695C;">å…’ç«¥: ${t.priceChild}</span></div></div><div class="ticket-info-row"><span class="ticket-info-label">åœ°é»:</span><div class="ticket-info-value">${t.location || '-'}</div></div><div class="ticket-info-row"><span class="ticket-info-label">å‚™è¨»:</span><div class="ticket-info-value">${t.notes || '-'}</div></div>${t.image ? `<div style="margin-top:10px; border-top:1px dashed #ccc; padding-top:10px;"><b>æ†‘è­‰:</b><br>${formatContent(t.image)}</div>` : ''}</div>`).join('') : '<div style="text-align:center; padding:20px;">å°šç„¡ç¥¨åˆ¸è³‡æ–™</div>';
            document.getElementById('tickets-form').innerHTML = list.map((t, i) => `
                <div class="edit-group"><button class="icon-btn delete-btn-corner danger" onclick="removeArr('tickets', ${i})">ğŸ—‘ï¸</button>${Object.entries(ticketFields).map(([k, label]) => {if(k==='image'){return `<label>${label}</label><input placeholder="è²¼ä¸Šç¶²å€" value="${t[k]||''}" onchange="appData.tickets[${i}].${k}=this.value" id="ticket-img-${i}"><label class="file-upload-btn">ğŸ“ ä¸Šå‚³åœ–ç‰‡<input type="file" style="display:none;" accept="image/*" onchange="compressImage(this.files[0], (base64) => { appData.tickets[${i}].image = base64; document.getElementById('ticket-img-${i}').value = 'å·²è¼‰å…¥åœ–ç‰‡'; saveImage('tickets'); })"></label>`;} return `<label>${label}</label><input value="${t[k]||''}" onchange="appData.tickets[${i}].${k}=this.value">`;}).join('')}</div>`).join('');
        },
        phrases: () => {
            document.getElementById('view-phrases').innerHTML = appData.phrases.map(p => `<div class="card" style="padding:10px; display:flex; justify-content:space-between; align-items:center;"><div><div style="font-weight:bold;">${p.zh}</div><div style="color:var(--primary-color)">${p.th}</div></div><button class="icon-btn" onclick="speak('th-TH', null, '${p.th}')">ğŸ”Š</button></div>`).join('');
            document.getElementById('phrases-form').innerHTML = appData.phrases.map((p, i) => `<div class="edit-group"><button class="icon-btn delete-btn-corner danger" onclick="removeArr('phrases', ${i})">ğŸ—‘ï¸</button><input placeholder="ä¸­æ–‡" value="${p.zh}" onchange="appData.phrases[${i}].zh=this.value"><input placeholder="æ³°æ–‡" value="${p.th}" onchange="appData.phrases[${i}].th=this.value"></div>`).join('');
        },
        shopping: () => {
            document.getElementById('view-shopping').innerHTML = appData.shopping.map((s, i) => `
                <div class="shopping-item ${s.done ? 'checked' : ''}"><div class="check-circle" onclick="toggleShopCheck(${i})">${s.done ? 'âœ”' : ''}</div><div style="flex-grow:1;">${s.category?`<div class="shopping-cat">${s.category}</div>`:''}<b>${s.item}</b> <span style="font-size:0.8rem; background:#eee;">${s.location}</span>${s.image?`<div style="margin-top:5px;">${formatContent(s.image)}</div>`:''}${s.notes?`<div style="font-size:0.85rem; color:#666; margin-top:2px;">å‚™è¨»: ${s.notes}</div>`:''}</div><div style="font-weight:bold; color:var(--primary-color);">à¸¿${s.price}</div></div>`).join('');
            document.getElementById('shopping-form').innerHTML = appData.shopping.map((s, i) => `
                <div class="edit-group"><button class="icon-btn delete-btn-corner danger" onclick="removeArr('shopping', ${i})">ğŸ—‘ï¸</button><input placeholder="åˆ†é¡" value="${s.category||''}" onchange="appData.shopping[${i}].category=this.value"><input placeholder="å“é …" value="${s.item}" onchange="appData.shopping[${i}].item=this.value"><input placeholder="åƒ¹æ ¼" value="${s.price}" onchange="appData.shopping[${i}].price=this.value"><input placeholder="åœ°é»" value="${s.location}" onchange="appData.shopping[${i}].location=this.value"><input placeholder="å‚™è¨»" value="${s.notes||''}" onchange="appData.shopping[${i}].notes=this.value"><input placeholder="åœ–ç‰‡ç¶²å€" value="${s.image||''}" onchange="appData.shopping[${i}].image=this.value" id="shop-img-${i}"><label class="file-upload-btn">ğŸ“ ä¸Šå‚³åœ–ç‰‡<input type="file" style="display:none;" accept="image/*" onchange="compressImage(this.files[0], (base64) => { appData.shopping[${i}].image = base64; document.getElementById('shop-img-${i}').value = 'å·²è¼‰å…¥åœ–ç‰‡'; saveImage('shopping'); })"></label></div>`).join('');
        },
        notes: () => {
            document.getElementById('view-notes').innerHTML = appData.notes.map(n => `<div class="card" style="background:#FFF9C4; white-space:pre-wrap;"><b>${n.date}</b>\n${n.content}</div>`).join('');
            document.getElementById('notes-form').innerHTML = appData.notes.map((n, i) => `<div class="edit-group"><button class="icon-btn delete-btn-corner danger" onclick="removeArr('notes', ${i})">ğŸ—‘ï¸</button><input placeholder="æ¨™é¡Œ" value="${n.date}" onchange="appData.notes[${i}].date=this.value"><textarea placeholder="å…§å®¹" onchange="appData.notes[${i}].content=this.value">${n.content}</textarea></div>`).join('');
        }
    };

    function addPax(type) { appData.flights[type].passengers.push({name:'', seat:''}); renderView('flights'); }
    function removePax(type, idx) { appData.flights[type].passengers.splice(idx, 1); renderView('flights'); }
    function addHotel() { appData.hotels.push({name:'', address:'', transport:'', checkin:'', checkout:'', voucher:'', photo:'', surroundings:'', notes:''}); renderView('hotel'); }
    function removeHotel(idx) { if(confirm('åˆªé™¤æ­¤é£¯åº—ï¼Ÿ')) { appData.hotels.splice(idx, 1); renderView('hotel'); } }
    function addDay() { appData.itinerary.push({date:'', summary:'', items:[]}); renderView('itinerary'); }
    function removeDay(idx) { if(confirm('åˆªé™¤æ•´å¤©è¡Œç¨‹ï¼Ÿ')) { appData.itinerary.splice(idx, 1); renderView('itinerary'); } }
    function addItm(dIdx) { appData.itinerary[dIdx].items.push({time:'', title:'', desc:'', transport:'', mapUrl:'', hours:'', mustBuy:'', menu:'', voucher:'', photo:'', notes:''}); renderView('itinerary'); }
    function removeItm(dIdx, iIdx) { appData.itinerary[dIdx].items.splice(iIdx, 1); renderView('itinerary'); }
    function addTicket() { appData.tickets.push({name:'', date:'', time:'', priceAdult:'', priceChild:'', location:'', image:'', notes:''}); renderView('tickets'); }
    function addPhrase() { appData.phrases.unshift({zh:'', th:''}); renderView('phrases'); }
    function addShoppingItem() { appData.shopping.push({item:'', price:'', location:'', category:'', image:'', notes:'', done:false}); renderView('shopping'); }
    function addNote() { appData.notes.push({date:'', content:''}); renderView('notes'); }
    function removeArr(section, idx) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { appData[section].splice(idx, 1); renderView(section); } }
    function toggleShopCheck(idx) { appData.shopping[idx].done = !appData.shopping[idx].done; saveToLocal(); renderView('shopping'); }

    function speak(lang, inputId, directText) { 
        const text = directText || document.getElementById(inputId).value;
        if(!text) return;
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = lang; 
        const voices = window.speechSynthesis.getVoices();
        let targetVoice = voices.find(v => v.lang === 'th-TH') || voices.find(v => v.lang.startsWith('th'));
        if (targetVoice && lang.startsWith('th')) { msg.voice = targetVoice; }
        msg.rate = 0.9; 
        window.speechSynthesis.speak(msg); 
    }
    window.speechSynthesis.onvoiceschanged = function() { window.speechSynthesis.getVoices(); };

    function mockTranslate() {
        const text = document.getElementById('trans-input').value;
        if (!text) { alert("è«‹å…ˆè¼¸å…¥ä¸­æ–‡ï¼"); return; }
        window.open(`https://translate.google.com/?sl=zh-TW&tl=th&text=${encodeURIComponent(text)}&op=translate`, '_blank');
    }

    let mapScale = 100;
    function zoomMap(delta) {
        if(delta === 0) mapScale = 100;
        else mapScale += delta;
        if(mapScale < 100) mapScale = 100;
        document.getElementById('mrt-img').style.width = mapScale + '%';
    }

    document.addEventListener('DOMContentLoaded', () => { renderView('flights'); });
</script>

</body>
</html>